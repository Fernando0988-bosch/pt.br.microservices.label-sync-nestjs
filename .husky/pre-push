#!/usr/bin/env sh

echo "🧪 Executando testes antes do push..."

# Verificar se há commits anteriores e origin/main existe
if git rev-parse --verify origin/main >/dev/null 2>&1; then
  # origin/main existe, executar affected test
  echo "📊 Executando testes affected..."
  npx nx affected:test --coverage --base=origin/main --head=HEAD --maxWorkers=1
else
  # origin/main não existe, executar testes das libs principais
  echo "📊 Executando testes das bibliotecas principais..."
  npx nx run-many --target=test --projects=auth,rabbitmq,common --coverage --maxWorkers=1
fi

# Se os testes falharem, ainda permitir push (apenas avisar)
if [ $? -ne 0 ]; then
  echo "⚠️  Alguns testes falharam, mas permitindo push..."
  echo "💡 Corrija os testes após o push"
fi
